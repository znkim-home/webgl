import{vec3 as t,mat4 as e,vec4 as r,mat3 as i,vec2 as o}from"gl-matrix";var n=function(){function t(t){this._gl=t}return Object.defineProperty(t.prototype,"gl",{get:function(){return this._gl},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shaderInfo",{get:function(){return this._shaderInfo},enumerable:!1,configurable:!0}),t.prototype.init=function(t){var e=this.gl,r=this.createShader(e.VERTEX_SHADER,t.vertexShaderSource),i=this.createShader(e.FRAGMENT_SHADER,t.fragmentShaderSource),o=this.createShaderProgram(r,i);if(e.getProgramParameter(o,e.LINK_STATUS)){e.useProgram(o);var n={};t.attributes.forEach((function(t){if("a"!==t[0])throw new Error("Shader: attribute variable name is incorrect.");var r=t.replace("a","");r=r.replace(/^[A-Z]/,(function(t){return t.toLowerCase()})),n[r]=e.getAttribLocation(o,t)}));var a={};t.uniforms.forEach((function(t){if("u"!==t[0])throw new Error("Shader: uniform variable name is incorrect.");var r=t.replace("u","");r=r.replace(/^[A-Z]/,(function(t){return t.toLowerCase()})),a[r]=e.getUniformLocation(o,t)})),this._shaderInfo={shaderProgram:o,fragmentShader:i,vertexShader:r,attributeLocations:n,uniformLocations:a}}else console.error("Unable to initialize the shader program.")},t.prototype.createShader=function(t,e){var r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var o="An error occurred compiling the shaders:  ".concat(r.getShaderInfoLog(i));throw new Error(o)}return i},t.prototype.createShaderProgram=function(t,e){var r=this.gl,i=r.createProgram();return r.attachShader(i,t),r.attachShader(i,e),r.linkProgram(i),i},t.prototype.useProgram=function(){this.gl.useProgram(this.shaderInfo.shaderProgram)},t}(),a=function(){function o(t){this.init(t),this.getTransformMatrix()}return Object.defineProperty(o.prototype,"transformMatrix",{get:function(){return this.getTransformMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"modelViewMatrix",{get:function(){return this.getModelViewMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"rotationMatrix",{get:function(){return this.getRotationMatrix()},enumerable:!1,configurable:!0}),o.prototype.init=function(e){this.position=t.fromValues(0,0,0),this.rotation=t.fromValues(0,0,0),this.direction=t.fromValues(0,0,-1),this.up=t.fromValues(0,1,0),this.right=t.fromValues(1,0,0),(null==e?void 0:e.fovyDegree)&&(this.fovyDegree=e.fovyDegree,this.fovyRadian=Math.radian(e.fovyDegree)),(null==e?void 0:e.position)?this.position=t.set(this.position,e.position.x,e.position.y,e.position.z):this.position=t.set(this.position,0,0,0),(null==e?void 0:e.rotation)?this.rotation=t.set(this.rotation,e.rotation.heading,e.rotation.pitch,e.rotation.roll):this.rotation=t.set(this.rotation,0,0,0),this.dirty=!0},o.prototype.syncFovyDegree=function(t){void 0===t&&(t=this.fovyDegree),this.fovyDegree=t,this.fovyRadian=Math.radian(this.fovyDegree)},o.prototype.moveCamera=function(e,r,i){var o=t.subtract(t.create(),r,i);t.add(this.position,e,o),this.dirty=!0},o.prototype.rotationOrbit=function(o,n,a){var s=this.right,u=e.fromZRotation(e.create(),o),f=e.fromRotation(e.create(),n,s),h=e.multiply(e.create(),u,f),l=t.subtract(t.create(),this.position,a),c=r.fromValues(l[0],l[1],l[2],1),p=r.transformMat4(r.create(),c,h),d=t.fromValues(p[0],p[1],p[2]),m=t.add(t.create(),d,a);this.position=m;var b=i.fromMat4(i.create(),h),v=t.transformMat3(t.create(),this.direction,b);this.direction=v;var x=t.transformMat3(t.create(),this.up,b);this.up=x,this.dirty=!0},o.prototype.rotate=function(r,o,n){this.rotation[0]+=r,this.rotation[1]+=o,this.rotation[2]+=n;var a=e.identity(e.create());e.rotate(a,a,Math.radian(this.rotation[0]),[0,1,0]);var s=e.identity(e.create());e.rotate(s,s,Math.radian(this.rotation[2]),[0,0,-1]);var u=e.identity(e.create());e.rotate(u,u,Math.radian(this.rotation[1]),[1,0,0]);var f=e.identity(e.create());e.multiply(f,f,a),e.multiply(f,f,s),e.multiply(f,f,u);var h=i.fromMat4(i.create(),f),l=t.transformMat3(t.create(),[0,0,-1],h);this.direction=l;var c=t.transformMat3(t.create(),[0,1,0],h);this.up=c,this.dirty=!0},o.prototype.lookAt=function(r){var i=t.normalize(t.create(),t.subtract(t.create(),this.position,r)),o=t.normalize(t.create(),t.cross(t.create(),this.up,i)),n=t.normalize(t.create(),t.cross(t.create(),i,o)),a=e.fromValues(o[0],o[1],o[2],0,n[0],n[1],n[2],0,i[0],i[1],i[2],0,this.position[0],this.position[1],this.position[2],1);return this._transformMatrix=a,a},o.prototype.moveForward=function(t){var r=e.create();e.identity(r),e.translate(r,r,[0,0,t]),e.multiply(this._transformMatrix,this._transformMatrix,r),this.setPositionSync()},o.prototype.moveRight=function(t){var r=e.create();e.identity(r),e.translate(r,r,[t,0,0]),e.multiply(this._transformMatrix,this._transformMatrix,r),this.setPositionSync()},o.prototype.moveUp=function(t){var r=e.create();e.identity(r),e.translate(r,r,[0,t,0]),e.multiply(this._transformMatrix,this._transformMatrix,r),this.setPositionSync()},o.prototype.setPositionSync=function(){this.position[0]=this._transformMatrix[12],this.position[1]=this._transformMatrix[13],this.position[2]=this._transformMatrix[14]},o.prototype.setRotationSync=function(){this.right[0]=this._transformMatrix[0],this.right[1]=this._transformMatrix[1],this.right[2]=this._transformMatrix[2],this.up[0]=this._transformMatrix[4],this.up[1]=this._transformMatrix[5],this.up[2]=this._transformMatrix[6],this.direction[0]=-this._transformMatrix[8],this.direction[1]=-this._transformMatrix[9],this.direction[2]=-this._transformMatrix[10]},o.prototype.translate=function(t,e,r){this.position[0]+=t,this.position[1]+=e,this.position[2]+=r,this.dirty=!0},o.prototype.setPosition=function(t,e,r){this.position[0]=t,this.position[1]=e,this.position[2]=r,this.dirty=!0},o.prototype.calcRight=function(){this.right=t.cross(this.right,this.direction,this.up)},o.prototype.getModelViewMatrix=function(){if(!this._modelViewMatrix||this.dirty){var t=this.getTransformMatrix(),r=e.create();this._modelViewMatrix=e.invert(r,t)}return this._modelViewMatrix},o.prototype.getTransformMatrix=function(){return this._transformMatrix&&!this.dirty||(this.calcRight(),this._transformMatrix=e.fromValues(this.right[0],this.right[1],this.right[2],0,this.up[0],this.up[1],this.up[2],0,-this.direction[0],-this.direction[1],-this.direction[2],0,this.position[0],this.position[1],this.position[2],1)),this._transformMatrix},o.prototype.getRotationMatrix=function(){return!this._rotationMatrix||this.dirty?(this.getTransformMatrix(),this._rotationMatrix=e.clone(this._transformMatrix),this._rotationMatrix[12]=0,this._rotationMatrix[13]=0,this._rotationMatrix[14]=0,this._rotationMatrix):this._rotationMatrix},o.prototype.getNormalMatrix=function(){var t=e.create(),r=this.getModelViewMatrix();return e.invert(r,r),e.transpose(t,r),t[3]=0,t[7]=0,t[11]=0,t},o.prototype.getViewRay=function(e,r){void 0===r&&(r=1);var i=Math.radian(this.fovyDegree),o=e.width/e.height,n=2*Math.tan(i/2)*r,a=n*o;return t.fromValues(a*(e.x-.5),n*(e.y-.5),-r)},o}(),s=function(){function o(t){this.init(t),this.getTransformMatrix()}return Object.defineProperty(o.prototype,"transformMatrix",{get:function(){return this.getTransformMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"modelViewMatrix",{get:function(){return this.getModelViewMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"rotationMatrix",{get:function(){return this.getRotationMatrix()},enumerable:!1,configurable:!0}),o.prototype.init=function(e){this.position=t.fromValues(0,0,0),this.rotation=t.fromValues(0,0,0),this.direction=t.fromValues(0,0,-1),this.up=t.fromValues(0,1,0),this.right=t.fromValues(1,0,0),(null==e?void 0:e.fovyDegree)&&(this.fovyDegree=e.fovyDegree,this.fovyRadian=Math.radian(e.fovyDegree)),(null==e?void 0:e.position)?this.position=t.set(this.position,e.position.x,e.position.y,e.position.z):this.position=t.set(this.position,0,0,0),(null==e?void 0:e.rotation)?this.rotation=t.set(this.rotation,e.rotation.heading,e.rotation.pitch,e.rotation.roll):this.rotation=t.set(this.rotation,0,0,0),this.dirty=!0},o.prototype.moveCamera=function(e,r,i){var o=t.subtract(t.create(),r,i);t.add(this.position,e,o),this.dirty=!0},o.prototype.rotationOrbit=function(o,n,a){var s=this.right,u=e.fromZRotation(e.create(),o),f=e.fromRotation(e.create(),n,s),h=e.multiply(e.create(),u,f),l=t.subtract(t.create(),this.position,a),c=r.fromValues(l[0],l[1],l[2],1),p=r.transformMat4(r.create(),c,h),d=t.fromValues(p[0],p[1],p[2]),m=t.add(t.create(),d,a);this.position=m;var b=i.fromMat4(i.create(),h),v=t.transformMat3(t.create(),this.direction,b);this.direction=v;var x=t.transformMat3(t.create(),this.up,b);this.up=x,this.dirty=!0},o.prototype.rotate=function(r,o,n){this.rotation[0]+=r,this.rotation[1]+=o,this.rotation[2]+=n;var a=e.identity(e.create());e.rotate(a,a,Math.radian(this.rotation[0]),[0,1,0]);var s=e.identity(e.create());e.rotate(s,s,Math.radian(this.rotation[2]),[0,0,-1]);var u=e.identity(e.create());e.rotate(u,u,Math.radian(this.rotation[1]),[1,0,0]);var f=e.identity(e.create());e.multiply(f,f,a),e.multiply(f,f,s),e.multiply(f,f,u);var h=i.fromMat4(i.create(),f),l=t.transformMat3(t.create(),[0,0,-1],h);this.direction=l;var c=t.transformMat3(t.create(),[0,1,0],h);this.up=c,this.dirty=!0},o.prototype.lookAt=function(r){var i=t.normalize(t.create(),t.subtract(t.create(),this.position,r)),o=t.normalize(t.create(),t.cross(t.create(),this.up,i)),n=t.normalize(t.create(),t.cross(t.create(),i,o)),a=e.fromValues(o[0],o[1],o[2],0,n[0],n[1],n[2],0,i[0],i[1],i[2],0,this.position[0],this.position[1],this.position[2],1);return this._transformMatrix=a,a},o.prototype.moveForward=function(t){var r=e.create();e.identity(r),e.translate(r,r,[0,0,t]),e.multiply(this.transformMatrix,this.transformMatrix,r),this.setPositionSync()},o.prototype.moveRight=function(t){var r=e.create();e.identity(r),e.translate(r,r,[t,0,0]),e.multiply(this.transformMatrix,this.transformMatrix,r),this.setPositionSync()},o.prototype.moveUp=function(t){var r=e.create();e.identity(r),e.translate(r,r,[0,t,0]),e.multiply(this.transformMatrix,this.transformMatrix,r),this.setPositionSync()},o.prototype.setPositionSync=function(){this.position[0]=this.transformMatrix[12],this.position[1]=this.transformMatrix[13],this.position[2]=this.transformMatrix[14]},o.prototype.setRotationSync=function(){this.right[0]=this.transformMatrix[0],this.right[1]=this.transformMatrix[1],this.right[2]=this.transformMatrix[2],this.up[0]=this.transformMatrix[4],this.up[1]=this.transformMatrix[5],this.up[2]=this.transformMatrix[6],this.direction[0]=-this.transformMatrix[8],this.direction[1]=-this.transformMatrix[9],this.direction[2]=-this.transformMatrix[10]},o.prototype.translate=function(t,e,r){this.position[0]+=t,this.position[1]+=e,this.position[2]+=r,this.dirty=!0},o.prototype.setPosition=function(t,e,r){this.position[0]=t,this.position[1]=e,this.position[2]=r,this.dirty=!0},o.prototype.getModelViewMatrix=function(){if(!this._modelViewMatrix||this.dirty){var t=this.getTransformMatrix(),r=e.create();this._modelViewMatrix=e.invert(r,t)}return this._modelViewMatrix},o.prototype.getTransformMatrix=function(){return this._transformMatrix&&!this.dirty||(this.calcRight(),this._transformMatrix=e.fromValues(this.right[0],this.right[1],this.right[2],0,this.up[0],this.up[1],this.up[2],0,-this.direction[0],-this.direction[1],-this.direction[2],0,this.position[0],this.position[1],this.position[2],1)),this._transformMatrix},o.prototype.calcRight=function(){this.right=t.cross(this.right,this.direction,this.up)},o.prototype.getRotationMatrix=function(){if(!this._rotationMatrix||this.dirty){var t=this.getTransformMatrix();this._rotationMatrix=e.clone(t),this._rotationMatrix[12]=0,this._rotationMatrix[13]=0,this._rotationMatrix[14]=0}return this._rotationMatrix},o.prototype.getNormalMatrix=function(){var t=e.create(),r=this.getModelViewMatrix();return e.invert(r,r),e.transpose(t,r),t[3]=0,t[7]=0,t[11]=0,t},o.prototype.getViewRay=function(e,r){var i=Math.radian(this.fovyDegree),o=e.width/e.height,n=2*Math.tan(i/2)*r,a=n*o;return t.fromValues(a*(e.x-.5),n*(e.y-.5),-r)},o}(),u=function(){function e(t,e,r,i,o){this.gl=t,this.canvas=e,this.shaderInfo=r,this.frameBuffer=t.createFramebuffer(),this.renderBuffer=t.createRenderbuffer(),this.texture=t.createTexture(),this.options=i,this.globalOptions=o,this.init()}return e.prototype.init=function(){var e,r,i,o,n,a=this.gl,s=this.canvas;if(this.textureType=(null===(e=this.options)||void 0===e?void 0:e.textureType)?this.options.textureType:0,this.clearColor=(null===(r=this.options)||void 0===r?void 0:r.clearColor)?this.options.clearColor:t.fromValues(1,1,1),this.name=(null===(i=this.options)||void 0===i?void 0:i.name)?this.options.name:"Untitled FrameBuffer",this.widths=new Int32Array([(null===(o=this.options)||void 0===o?void 0:o.width)?this.options.width:s.width]),this.heights=new Int32Array([(null===(n=this.options)||void 0===n?void 0:n.height)?this.options.height:s.height]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.widths[0],this.heights[0],0,a.RGBA,a.UNSIGNED_BYTE,null),a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.bindRenderbuffer(a.RENDERBUFFER,this.renderBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.widths[0],this.heights[0]),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this.renderBuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.texture,0),a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete frame buffer object.");a.bindFramebuffer(a.FRAMEBUFFER,null)},e.prototype.clear=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.bindFramebuffer(t.FRAMEBUFFER,null)},e.prototype.bind=function(t){void 0===t&&(t=this.shaderInfo);var e=this.gl;e.uniform1i(t.uniformLocations.textureType,this.textureType),e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer)},e.prototype.unbind=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null)},e.prototype.getNormal=function(t,e){var r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer);var i=new Uint8Array(4);r.bindTexture(r.TEXTURE_2D,this.texture),r.readPixels(t,e,1,1,r.RGBA,r.UNSIGNED_BYTE,i),r.bindFramebuffer(r.FRAMEBUFFER,null);var o=new Float32Array([i[0]/255,i[1]/255,i[2]/255,i[3]/255]);return this.decodeNormal(o)},e.prototype.getColor=function(t,e){var r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer);var i=new Uint8Array(4);return r.bindTexture(r.TEXTURE_2D,this.texture),r.readPixels(t,e,1,1,r.RGBA,r.UNSIGNED_BYTE,i),r.bindFramebuffer(r.FRAMEBUFFER,null),this.convertColorToId(i)},e.prototype.getDepth=function(t,e){var r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer);var i=new Uint8Array(4);r.bindTexture(r.TEXTURE_2D,this.texture),r.readPixels(t,e,1,1,r.RGBA,r.UNSIGNED_BYTE,i),r.bindFramebuffer(r.FRAMEBUFFER,null);var o=new Float32Array([i[0]/255,i[1]/255,i[2]/255,i[3]/255]);return this.unpackDepth(o)*this.globalOptions.far},e.prototype.convertIdToColor=function(t){var e=function(t,e){return Math.floor(t/e)%256/255};return r.fromValues(e(t,16777216),e(t,65536),e(t,256),e(t,1))},e.prototype.convertColorToId=function(t){return 16777216*t[0]+65536*t[1]+256*t[2]+t[3]},e.prototype.convertColor255ToId=function(t){return 16777216*t[0]*255+65536*t[1]*255+256*t[2]*255+255*t[3]},e.prototype.unpackDepth=function(t){return t[0]+1*t[1]/255+1*t[2]/65025+1*t[3]/16581375},e.prototype.decodeNormal=function(e){var r=t.fromValues(2*e[0]-1,2*e[1]-1,2*e[2]-1);return t.normalize(r,r),r},e}(),f=function(){function t(){this.init()}return t.prototype.init=function(){this.renderableObjects=[]},t.prototype.findById=function(t){return this.renderableObjects.find((function(e){return e.id===t}))},t.prototype.set=function(t){this.renderableObjects=t},t.prototype.get=function(){return this.renderableObjects},t.prototype.push=function(t){this.renderableObjects.push(t)},t.prototype.pop=function(){return this.renderableObjects.pop()},t.prototype.size=function(){return this.renderableObjects.length},t.prototype.removeAll=function(){this.renderableObjects.length=0},t}(),h={attributes:["aVertexPosition","aVertexColor","aVertexSelectionColor","aVertexNormal","aTextureCoordinate"],uniforms:["uModelViewMatrix","uProjectionMatrix","uOrthographicMatrix","uObjectMatrix","uRotationMatrix","uNormalMatrix","uPointSize","uNearFar","uPositionType","uTexture","uTextureType"],vertexShaderSource:"\n  attribute vec3 aVertexPosition;\n  attribute vec4 aVertexColor;\n  attribute vec4 aVertexSelectionColor;\n  attribute vec3 aVertexNormal;\n  attribute vec2 aTextureCoordinate;\n  \n  uniform mat4 uModelViewMatrix;\n  uniform mat4 uProjectionMatrix;\n  uniform mat4 uOrthographicMatrix;\n  uniform mat4 uObjectMatrix;\n  uniform mat4 uRotationMatrix;\n  uniform mat4 uNormalMatrix;\n  uniform float uPointSize;\n  uniform vec2 uNearFar;\n  uniform int uPositionType; // 1: plane, 2: depth, basic\n\n  varying vec4 vColor;\n  varying vec4 vSelectionColor;\n  varying vec3 vTransformedNormal;\n  varying vec2 vTextureCoordinate;\n  varying float vDepth;\n\n  vec4 getOrthoPosition() {\n    vec4 transformedPosition = uObjectMatrix * vec4(aVertexPosition, 1.0);\n    vec4 orthoPosition = uModelViewMatrix * vec4(transformedPosition.xyz, 1.0);\n    return orthoPosition;\n  }\n  vec3 getRotatedNormal() {\n    vec3 rotatedModelNormal = (uRotationMatrix * vec4(aVertexNormal, 1.0)).xyz;\n    vec3 rotatedNormal = normalize(uNormalMatrix * vec4(rotatedModelNormal, 1.0)).xyz;\n    return rotatedNormal;\n  }\n  float calcDepth(float zValue) {\n    return -(zValue / uNearFar.y);\n  }\n\n  void main(void) {\n    vColor = aVertexColor;\n    vSelectionColor = aVertexSelectionColor;\n    gl_PointSize = uPointSize;\n\n    vec4 orthoPosition = getOrthoPosition();\n    vTransformedNormal = getRotatedNormal();\n\n    vDepth = calcDepth(orthoPosition.z);\n    gl_Position = uProjectionMatrix * orthoPosition;\n    \n    vTextureCoordinate = aTextureCoordinate;\n  }\n",fragmentShaderSource:"\n  precision highp float;\n\n  varying vec4 vColor;\n  varying vec4 vSelectionColor;\n  varying vec2 vTextureCoordinate;\n  varying vec3 vTransformedNormal;\n  varying float vDepth;\n\n  uniform sampler2D uTexture;\n  uniform int uTextureType; // default : color, 1 : texture, 2 : reverseY, 3 : depth\n  \n  vec3 encodeNormal(in vec3 normal) {\n    return normal.xyz * 0.5 + 0.5;\n  }\n  vec3 decodeNormal(in vec3 normal){\n    return normal * 2.0 - 1.0;\n  }\n  vec4 packDepth(float depth) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n  }\n\n  void main(void) {\n    if (uTextureType == 1) {\n      //gl_FragColor = vec4(vColor.xyz, vColor.a);\n      gl_FragColor = texture2D(uTexture, vec2(vTextureCoordinate.x, 1.0 - vTextureCoordinate.y));\n    } else if (uTextureType == 2) {\n      gl_FragColor = vec4(vSelectionColor.xyz, vSelectionColor.a);\n    } else if (uTextureType == 3) {\n      gl_FragColor = packDepth(vDepth);\n    } else if (uTextureType == 4) {\n      gl_FragColor = vec4(encodeNormal(vTransformedNormal), 1.0);\n    } else if (uTextureType == 5) {\n      gl_FragColor = vec4(vColor.xyz, vColor.a);\n    }  else {\n      gl_FragColor = vec4(vColor.xyz, vColor.a);\n    }\n  }\n"},l=function(t,e){return l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},l(t,e)};function c(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var p=function(){function t(t,e,r){this._gl=t,this._canvas=t.canvas,this._shader=e,this._shaderInfo=e.shaderInfo,this._globalOptions=r}return t.prototype.preprocess=function(){throw new Error("preprocess() is abstract method. Abstract methods must be overriding.")},t.prototype.process=function(){throw new Error("process() is abstract method. Abstract methods must be overriding.")},t.prototype.postprocess=function(){throw new Error("postprocess() is abstract method. Abstract methods must be overriding.")},Object.defineProperty(t.prototype,"gl",{get:function(){return this._gl},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"globalOptions",{get:function(){return this._globalOptions},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shaderInfo",{get:function(){return this._shaderInfo},enumerable:!1,configurable:!0}),t}(),d=function(t){function r(e,r,i,o,n,a){var s=t.call(this,e,r,i)||this;return s.camera=o,s.frameBufferObjs=n,s.renderableList=a,s}return c(r,t),r.prototype.preprocess=function(){},r.prototype.process=function(){var t=this,r=this.gl,i=this.shaderInfo,n=this.globalOptions;this.shader.useProgram();var a=e.create();e.perspective(a,this.camera.fovyRadian,n.aspect,n.near,n.far);var s=this.camera.getModelViewMatrix(),u=this.camera.getNormalMatrix();r.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,a),r.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,s),r.uniformMatrix4fv(i.uniformLocations.normalMatrix,!1,u),r.uniform2fv(i.uniformLocations.nearFar,o.fromValues(n.near,n.far)),r.uniform1f(i.uniformLocations.pointSize,n.pointSize),r.uniform1i(i.uniformLocations.textureType,0),this.frameBufferObjs.forEach((function(t){t.clear()})),this.renderableList.get().forEach((function(e){void 0===e.getId()&&e.createRenderableObjectId(t.renderableList),e.render(r,i,t.frameBufferObjs)}))},r.prototype.postprocess=function(){},r}(p),m={attributes:["aVertexPosition","aTextureCoordinate"],uniforms:["uIsMain","uSsaoKernel","uScreenSize","uNoiseScale","uAspectRatio","uProjectionMatrix","uTangentOfHalfFovy","uNearFar","uMainTexture","uAlbedoTexture","uSelectionTexture","uNormalTexture","uDepthTexture","uNoiseTexture","uLightMapTexture","uCameraTransformMatrix","uSunModelViewMatrix","uOrthographicMatrix","uSunNormalMatrix","uEnableGlobalLight","uEnableEdge","uEnableSsao","uSelectedObjectId"],vertexShaderSource:"\n  #pragma vscode_glsllint_stage : vert\n  attribute vec3 aVertexPosition;\n  attribute vec2 aTextureCoordinate;\n\n  varying vec2 vTextureCoordinate;\n  void main(void) {\n    vTextureCoordinate = aTextureCoordinate;\n    gl_Position = vec4(aVertexPosition.xy * 2.0 - 1.0, 0.0, 1.0);\n  }\n",fragmentShaderSource:"\n  #pragma vscode_glsllint_stage : frag\n  precision highp float;\n  \n  uniform int uIsMain;\n  uniform float uTangentOfHalfFovy;\n  uniform float uAspectRatio;\n\n  uniform vec2 uScreenSize;  \n  uniform vec2 uNearFar;\n  uniform vec2 uNoiseScale;\n  uniform mat4 uProjectionMatrix;\n  uniform mat4 uCameraTransformMatrix;\n  uniform mat4 uSunModelViewMatrix;\n  uniform mat4 uOrthographicMatrix;\n  uniform mat4 uSunNormalMatrix;\n\n  uniform sampler2D uMainTexture;\n  uniform sampler2D uAlbedoTexture;\n  uniform sampler2D uSelectionTexture;\n  uniform sampler2D uNormalTexture;\n  uniform sampler2D uDepthTexture;\n  uniform sampler2D uLightMapTexture;\n  uniform sampler2D uNoiseTexture;\n  uniform vec3 uSsaoKernel[16];\n\n  uniform int uEnableGlobalLight;\n  uniform int uEnableEdge;\n  uniform int uEnableSsao;\n  uniform float uSelectedObjectId;\n\n  varying vec2 vTextureCoordinate;\n  \n  const int kernelSize = 16;\n  const float fKernelSize = float(kernelSize);\n\n  vec4 decodeNormal(in vec4 normal) {\n    return vec4(normal.xyz * 2.0 - 1.0, normal.w);\n  }\n  float convertColorToId(vec4 color) {\n    return (color.r * 255.0 * 16777216.0) + (color.g * 255.0 * 65536.0) + (color.b * 255.0 * 256.0) + (color.a * 255.0);\n  }\n  float unpackDepth(vec4 packedDepth) {\n    return dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n  }\n  vec3 getViewRay(vec2 tc, in float relFar) {\n    float hfar = 2.0 * uTangentOfHalfFovy * relFar;\n    float wfar = hfar * uAspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n    return ray;\n  }\n  vec4 getAlbedo(vec2 screenPos) {\n    return texture2D(uAlbedoTexture, screenPos);\n  }\n  vec4 getSelection(vec2 screenPos) {\n    return texture2D(uSelectionTexture, screenPos);\n  }\n  vec4 getNormal(vec2 screenPos) {\n    return texture2D(uNormalTexture, screenPos);\n  }\n  vec4 getDepth(vec2 screenPos) {\n    //return texture2D(uLightMapTexture, screenPos);\n    return texture2D(uDepthTexture, screenPos);\n  }\n\n  float getOcclusion(vec3 origin, vec3 rotatedKernel, float radius) {\n    float resultOcclusion = 1.0;\n    vec3 sample = origin + (rotatedKernel * radius);\n    vec4 offset = uProjectionMatrix * vec4(sample, 1.0);\n    vec3 offsetCoord = vec3(offset.xyz);\t\t\t\t\n    offsetCoord.xyz /= offset.w;\n    offsetCoord.xyz = offsetCoord.xyz * 0.5 + 0.5;\n    if ((abs(offsetCoord.x) > 1.0 || abs(offsetCoord.y) > 1.0) && (abs(offsetCoord.x) < 0.0 || abs(offsetCoord.y) < 0.0)) {\n        resultOcclusion = 0.0;\n    } else {\n      float depthBufferValue = unpackDepth(texture2D(uDepthTexture, offsetCoord.xy));\n      float sampleZ = -sample.z;\n      float bufferZ = depthBufferValue * uNearFar.y;\n      float zDiff = abs(bufferZ - sampleZ);\n      if (zDiff < radius) {\n        if (bufferZ < sampleZ) {\n          resultOcclusion = 0.0;\n        }\n      }\n    }\n    return resultOcclusion;\n  }\n\n  vec4 getSSAO(in vec2 screenPos) {\n    float occlusionA = 0.0;\n    float occlusionB = 0.0;\n    float occlusionC = 0.0;\n\n    float linearDepth = unpackDepth(getDepth(screenPos));\n    float originDepth = linearDepth * uNearFar.y;\n    vec3 origin = getViewRay(screenPos, originDepth);\n    vec3 normal = decodeNormal(texture2D(uNormalTexture, screenPos)).xyz;\n\n    vec3 rvec = texture2D(uNoiseTexture, screenPos.xy * uNoiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal * dot(rvec, normal));\n\t\tvec3 bitangent = normalize(cross(normal, tangent));\n\t\tmat3 tbn = mat3(tangent, bitangent, normal);   \n\t\tfor (int i = 0; i < kernelSize; i++) {    \t\n      vec3 rotatedKernel = tbn * vec3(uSsaoKernel[i].x, uSsaoKernel[i].y, uSsaoKernel[i].z);\n      occlusionA += getOcclusion(origin, rotatedKernel, 8.5);\n      occlusionB += getOcclusion(origin, rotatedKernel, 16.0);\n      occlusionC += getOcclusion(origin, rotatedKernel, 32.0);\n    }\n\n    float tolerance = 0.80;\n    float result = (occlusionA + occlusionB + occlusionC) / (fKernelSize * 3.0);\n    if (result > tolerance) {\n      result = 1.0;\n    }\n    //return result;\n\n    return vec4(occlusionA / fKernelSize, occlusionB / fKernelSize, occlusionC / fKernelSize, 1.0);\n  }\n\n  float compareNormalOffset(in vec4 normalA, in vec4 normalB) {\n    float result = 0.0; \n    result += abs(normalA.x - normalB.x);\n    result += abs(normalA.y - normalB.y);\n    result += abs(normalA.z - normalB.z);\n    return result;\n  }\n\n  bool isEdge(vec2 screenPos) {\n    float width = 1.0 / uScreenSize.x;\n\t  float height = 1.0 / uScreenSize.y;\n    vec2 rightPos = vec2(screenPos.x + width, screenPos.y);\n    vec2 bottomPos = vec2(screenPos.x, screenPos.y + height);\n    vec2 crossPos = vec2(screenPos.x + width, screenPos.y + height);\n    vec2 leftPos = vec2(screenPos.x - width, screenPos.y);\n    \n    float selection = convertColorToId(getSelection(screenPos));\n    float selectionRight = convertColorToId(getSelection(rightPos));\n    float selectionBottom = convertColorToId(getSelection(bottomPos));\n    float selectionCross = convertColorToId(getSelection(crossPos));\n    float selectionLeft = convertColorToId(getSelection(leftPos));\n\n    vec4 normal = decodeNormal(getNormal(screenPos));\n    vec4 normalRight = decodeNormal(getNormal(rightPos));\n    vec4 normalBottom = decodeNormal(getNormal(bottomPos));\n    vec4 normalCross = decodeNormal(getNormal(crossPos));\n\n    float compareOffset = 0.3;\n    bool normalCompareRight = compareOffset < compareNormalOffset(normal, normalRight);\n    bool normalCompareBottom = compareOffset < compareNormalOffset(normal, normalBottom);\n    bool normalCompareCross = compareOffset < compareNormalOffset(normal, normalCross);\n\n    bool isEdgeByNormalCompare = normalCompareRight || normalCompareBottom || normalCompareCross;\n    bool isEdgeBySelection = selection != selectionBottom || selection != selectionRight || selection != selectionCross || selection != selectionLeft;\n\n    return isEdgeByNormalCompare || isEdgeBySelection;\n  }\n\n  bool isShadow(vec2 screenPos) {\n    bool result = false;\n\n    float linearDepth = unpackDepth(getDepth(screenPos));\n    float originDepth = linearDepth * uNearFar.y;\n    vec3 positionCC = getViewRay(screenPos, originDepth);\n    vec4 positionWC = uCameraTransformMatrix * vec4(positionCC, 1.0);\n    vec4 positionSC = uSunModelViewMatrix * vec4(positionWC.xyz, 1.0);\n\n    positionSC = uOrthographicMatrix * positionSC;\n    vec3 positionUnitarySCaux = positionSC.xyz / positionSC.w; // Range : -1.0 ~ 1.0\n    vec3 positionUnitarySC = positionUnitarySCaux * 0.5 + 0.5; // Range = 0.0 ~ 1.0\n\n    if (positionUnitarySC.z > 0.9999) {\n      return result;\n    }\n    if (positionUnitarySC.x > 1.0 || positionUnitarySC.x < 0.0 || positionUnitarySC.y > 1.0 || positionUnitarySC.y < 0.0) {\n      return result;\n    }\n\n    vec4 fromDepthSunTextureVec4 = texture2D(uLightMapTexture, positionUnitarySC.xy) ;\n    fromDepthSunTextureVec4 = fromDepthSunTextureVec4 * 1.001;\n    float fromDepthSunTexture = unpackDepth(fromDepthSunTextureVec4);\n\n    result = positionUnitarySC.z > fromDepthSunTexture;\n    return result;\n  }\n\n  void main(void) {\n    float width = 1.0 / uScreenSize.x;\n\t  float height = 1.0 / uScreenSize.y;\n    vec2 screenPos = vec2(gl_FragCoord.x / uScreenSize.x, gl_FragCoord.y / uScreenSize.y);\n\n    vec4 albedo = getAlbedo(screenPos);\n    vec4 normal = decodeNormal(getNormal(screenPos));\n\n    vec4 selectionColor = getSelection(screenPos);\n    float selection = convertColorToId(getSelection(screenPos));\n\n    vec3 ambientLight = vec3(0.3, 0.3, 0.3);\n    vec3 directionalLightColor = vec3(0.9, 0.9, 0.9);\n    vec3 directionalVector = normalize(vec3(0.6, 0.6, 0.9));\n    float directional = max(dot(normal.xyz, directionalVector), 0.0);\n    vec3 vLighting = ambientLight + (directionalLightColor * directional);\n\n    if (uIsMain == 1) {\n      vec3 result = albedo.xyz;\n      \n      if (uEnableSsao == 1) {\n        //float ssaoResult = getSSAO(screenPos);\n        float tolerance = 0.80;\n        vec4 ssaoResult = getSSAO(screenPos);\n\n        if (ssaoResult.x < tolerance) {\n          result = result * ssaoResult.x;\n        }\n        if (ssaoResult.y < tolerance) {\n          result = result * (ssaoResult.y + 0.1);\n        }\n        if (ssaoResult.z < tolerance) {\n          result = result * (ssaoResult.z + 0.2);\n        }\n        //result = result * ssaoResult;\n      }\n\n      //result = result * vLighting;\n      if (uEnableGlobalLight == 1 && isShadow(screenPos)) {\n        result = result * 0.5;\n      }\n\n      if (selection == uSelectedObjectId) {\n        result.b = result.b * 1.5;\n      }\n      if (uEnableEdge == 1 && isEdge(screenPos)) {\n        result = result * 0.5;\n        if (selection == uSelectedObjectId) {\n          result.b = 1.0;\n        }\n      }\n      gl_FragColor = vec4(result, 1.0);\n    } else {\n      vec4 textureColor = texture2D(uMainTexture, vTextureCoordinate);\n      gl_FragColor = vec4(textureColor.rgb, textureColor.a);\n    }\n  }\n"},b=function(){function t(t){this._gl=t}return Object.defineProperty(t.prototype,"gl",{get:function(){return this._gl},enumerable:!1,configurable:!0}),t.prototype.bindBuffer=function(t,e,r){void 0===e&&(e=3);var i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,t),i.vertexAttribPointer(r,e,i.FLOAT,!1,0,0)},t.prototype.createBuffer=function(t){var e=this.gl,r=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),r},t.prototype.createIndexBuffer=function(t){var e=this.gl,r=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,e.STATIC_DRAW),r},t.prototype.createTexture=function(t){var e=this.gl,r=e.CLAMP_TO_EDGE,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_NEAREST),e.generateMipmap(e.TEXTURE_2D),i},t.prototype.createNoiseTexture=function(){for(var t=new Uint8Array(64),e=0;e<4;e++)for(var r=0;r<4;r++)t[4*(4*e+r)+0]=Math.floor(255*Math.random()),t[4*(4*e+r)+1]=Math.floor(255*Math.random()),t[4*(4*e+r)+2]=Math.floor(255*Math.random()),t[4*(4*e+r)+3]=Math.floor(255*Math.random());var i=this.gl,o=i.createTexture();return i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,4,4,0,i.RGBA,i.UNSIGNED_BYTE,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),i.bindTexture(i.TEXTURE_2D,null),o},t}(),v=function(){function i(){if(this.constructor===i)throw new Error("Renderable is abstract class. Created an instance of an abstract class.");this.name="Untitled",this.position=t.fromValues(0,0,0),this.rotation=t.fromValues(0,0,0),this.color=r.fromValues(.4,.4,.4,1),this.selectionColor=r.fromValues(0,0,0,1),this.dirty=!1}return i.prototype.render=function(t,e,r){throw new Error("render() is abstract method. Abstract methods must be overriding.")},i.prototype.getBuffer=function(t){throw new Error("render() is abstract method. Abstract methods must be overriding.")},i.prototype.getTransformMatrix=function(){if(!this.transformMatrix||!0===this.dirty){var r=e.create();e.identity(r),e.rotate(r,r,Math.radian(this.rotation[1]),t.fromValues(0,1,0)),e.rotate(r,r,Math.radian(this.rotation[2]),t.fromValues(0,0,1)),e.rotate(r,r,Math.radian(this.rotation[0]),t.fromValues(1,0,0)),r[12]=this.position[0],r[13]=this.position[1],r[14]=this.position[2],this.transformMatrix=r}return this.transformMatrix},i.prototype.getRotationMatrix=function(){return this.rotationMatrix&&!0!==this.dirty||(this.rotationMatrix=e.clone(this.getTransformMatrix()),this.rotationMatrix[12]=0,this.rotationMatrix[13]=0,this.rotationMatrix[14]=0),this.rotationMatrix},i.prototype.getId=function(){return this.id},i.prototype.calcNormal=function(e,r,i){var o=t.create(),n=t.create();o=t.subtract(o,r,e),n=t.subtract(n,i,r);var a=t.create();return t.cross(a,o,n),t.normalize(a,a),a},i.prototype.intersection=function(t,e,r,i){var o=this.dot(this.cross(t,e,r),this.cross(t,e,i)),n=this.dot(this.cross(r,i,t),this.cross(r,i,e));return o<=0&&n<=0},i.prototype.cross=function(e,r,i){var o=t.subtract(t.create(),r,e),n=t.subtract(t.create(),i,r);return t.cross(t.create(),o,n)},i.prototype.dot=function(e,r){return t.dot(e,r)},i.prototype.normal=function(e,r,i){var o=this.cross(e,r,i);return t.normalize(o,o)},i.prototype.getMinMax=function(t){var e=Number.MAX_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;return t.forEach((function(t){e=t[0]<e?t[0]:e,r=t[1]<r?t[1]:r,i=t[0]>i?t[0]:i,o=t[1]>o?t[1]:o})),{minx:e,miny:r,maxx:i,maxy:o}},i.prototype.convertIdToColor=function(t){void 0===t&&(t=this.id);var e=function(t,e){return Math.floor(t/e)%256/255};return r.fromValues(e(t,16777216),e(t,65536),e(t,256),e(t,1))},i.prototype.convertColorToId=function(t){return 16777216*t[0]+65536*t[1]+256*t[2]+t[3]},i.prototype.createRenderableObjectId=function(t){for(var e=this.id,r=function(){var r=Math.ceil(1e7*Math.random());t.get().find((function(t){return t.id==r}))||(e=r,i.id=r,i.selectionColor=i.convertIdToColor(r))},i=this;void 0===e;)r();return e},i}(),x=function(){function e(t,e){this.set(t,e)}return e.prototype.set=function(t,e){this.normal=e,this.position=t,this.distance=-(e[0]*t[0]+e[1]*t[1]+e[2]*t[2])},e.prototype.getIntersection=function(e){var r=this.normal,i=e.position,o=e.direction,n=r[0]*o[0]+r[1]*o[1]+r[2]*o[2];if(Math.abs(n)>Number.MIN_VALUE){var a=-(r[0]*i[0]+r[1]*i[1]+r[2]*i[2]+this.distance)/n,s=i[0]+a*o[0],u=i[1]+a*o[1],f=i[2]+a*o[2];return t.fromValues(s,u,f)}return null},e}(),g=function(){function e(t,e,r){this.positions=[t,e,r],this.getNormal()}return e.prototype.get=function(t){return this.positions[t]},e.prototype.getNormal=function(){if(void 0===this.normal){var e=t.subtract(t.create(),this.positions[1],this.positions[0]),r=t.subtract(t.create(),this.positions[2],this.positions[1]),i=t.cross(t.create(),e,r);t.normalize(i,i),this.normal=i}return this.normal},e.prototype.getPlane=function(){return this.plane||(this.plane=new x(this.positions[0],this.normal)),this.plane},e}(),y=function(e){function i(t,r){var i=e.call(this)||this;return i.forDebug=!1,i.init(t,r),i}return c(i,e),i.prototype.init=function(e,i){this.length=0,this.name="Untitled Screen",e&&(this.coordinates=e),(null==i?void 0:i.position)&&(this.position=t.set(this.position,i.position.x,i.position.y,i.position.z)),(null==i?void 0:i.color)&&(this.color=r.set(this.color,null==i?void 0:i.color.r,null==i?void 0:i.color.g,null==i?void 0:i.color.b,null==i?void 0:i.color.a)),(null==i?void 0:i.texture)&&(this.texture=i.texture),(null==i?void 0:i.forDebug)&&(this.forDebug=i.forDebug),(null==i?void 0:i.textureLocation)&&(this.textureLocation=i.textureLocation)},i.prototype.setGlTextureNumber=function(t){this.glTextureNumber=t},i.prototype.render=function(t,e,r){var i=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.indicesGlBuffer),t.bindTexture(t.TEXTURE_2D,i.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),i.bindBuffer(i.textureGlBuffer,2,e.attributeLocations.textureCoordinate),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),i.bindBuffer(i.postionsGlBuffer,3,e.attributeLocations.vertexPosition),t.drawElements(t.TRIANGLES,i.indicesLength,t.UNSIGNED_SHORT,0),t.uniform1i(e.uniformLocations.textureType,0)},i.prototype.getBuffer=function(e){var r=this;if(this.dirty=void 0===this.buffer||this.length!=this.coordinates.length,!0===this.dirty){this.buffer=new b(e);var i=this.color,o=this.selectionColor,n=[],a=[],s=[],u=[],f=[],h=this.coordinates.map((function(e){return t.fromValues(e[0],e[1],r.position[2])})),l=this.getMinMax(h);[new g(h[0],h[2],h[3]),new g(h[0],h[1],h[2])].forEach((function(t){var e=t.positions,r=t.getNormal();e.forEach((function(t){t.forEach((function(t){return s.push(t)})),r.forEach((function(t){return u.push(t)})),i.forEach((function(t){return n.push(t)})),o.forEach((function(t){return a.push(t)}));var e=l.maxx-l.minx,h=l.maxy-l.miny;f.push((t[0]-l.minx)/e),f.push((t[1]-l.miny)/h)}))})),this.length=this.coordinates.length;var c=new Uint16Array(s.length/3);this.buffer.indicesVBO=c.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(s),this.buffer.colorVBO=new Float32Array(n),this.buffer.selectionColorVBO=new Float32Array(a),this.buffer.normalVBO=new Float32Array(u),this.buffer.textureVBO=new Float32Array(f),this.buffer.texture=this.texture,this.buffer.postionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},i}(v),B=function(t){function r(e,r,i,o,n,a){var s=t.call(this,e,r,i)||this;return s.camera=o,s.frameBufferObjs=n,s.buffer=new b(e),s.sun=a,s}return c(r,t),r.prototype.preprocess=function(){var t=this.gl,e=this.shaderInfo;this.screens=[],this.mainScreen=new y([[0,0],[1,0],[1,1],[0,1]],{reverse:!0,forDebug:!1,textureLocation:e.uniformLocations.mainTexture}),this.albedoScreen=new y([[.85,.85],[1,.85],[1,1],[.85,1]],{reverse:!0,forDebug:!0,textureLocation:e.uniformLocations.albedoTexture}),this.selectionScreen=new y([[.85,.7],[1,.7],[1,.85],[.85,.85]],{reverse:!0,forDebug:!0,textureLocation:e.uniformLocations.selectionTexture}),this.normalScreen=new y([[.85,.55],[1,.55],[1,.7],[.85,.7]],{reverse:!0,forDebug:!0,textureLocation:e.uniformLocations.normalTexture}),this.depthScreen=new y([[.85,.4],[1,.4],[1,.55],[.85,.55]],{reverse:!0,forDebug:!0,textureLocation:e.uniformLocations.depthTexture}),this.lightMapDepthScreen=new y([[.92,.25],[1,.25],[1,.4],[.92,.4]],{reverse:!0,forDebug:!0,textureLocation:e.uniformLocations.lightMapTexture}),this.screens.push(this.mainScreen),this.screens.push(this.albedoScreen),this.screens.push(this.selectionScreen),this.screens.push(this.normalScreen),this.screens.push(this.depthScreen),this.screens.push(this.lightMapDepthScreen),this.noiseTexture=this.buffer.createNoiseTexture(),this.mainScreen.glTextureNumber=t.TEXTURE0,this.albedoScreen.glTextureNumber=t.TEXTURE1,this.selectionScreen.glTextureNumber=t.TEXTURE2,this.normalScreen.glTextureNumber=t.TEXTURE3,this.depthScreen.glTextureNumber=t.TEXTURE4,this.lightMapDepthScreen.glTextureNumber=t.TEXTURE5,this.noiseTextureNumber=t.TEXTURE6},r.prototype.process=function(){var t=this.gl,r=this.canvas,i=this.shaderInfo,n=this.globalOptions;this.shader.useProgram(),t.viewport(0,0,r.width,r.height),t.enable(t.CULL_FACE),t.frontFace(t.CCW),t.lineWidth(n.lineWidth);var a=Math.radian(this.camera.fovyDegree),s=Math.tan(a/2),u=e.create();e.ortho(u,-8192,8192,-8192,8192,0,8192),t.uniformMatrix4fv(i.uniformLocations.orthographicMatrix,!1,u);var f=e.create();e.perspective(f,a,n.aspect,n.near,n.far),t.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,f);var h=this.camera.getTransformMatrix();t.uniformMatrix4fv(i.uniformLocations.cameraTransformMatrix,!1,h);var l=this.sun.getModelViewMatrix();t.uniformMatrix4fv(i.uniformLocations.sunModelViewMatrix,!1,l);var c=this.sun.getNormalMatrix();t.uniformMatrix4fv(i.uniformLocations.sunNormalMatrix,!1,c),t.uniform1i(i.uniformLocations.isMain,0),t.uniform1f(i.uniformLocations.selectedObjectId,n.selectedObjectId),t.uniform1f(i.uniformLocations.aspectRatio,n.aspect),t.uniform1i(i.uniformLocations.enableSsao,n.enableSsao?1:0),t.uniform1i(i.uniformLocations.enableEdge,n.enableEdge?1:0),t.uniform1i(i.uniformLocations.enableGlobalLight,n.enableGlobalLight?1:0),t.uniform1f(i.uniformLocations.tangentOfHalfFovy,s),t.uniform2fv(i.uniformLocations.screenSize,o.fromValues(r.width,r.height)),t.uniform2fv(i.uniformLocations.nearFar,o.fromValues(n.near,n.far)),t.uniform2fv(i.uniformLocations.noiseScale,o.fromValues(r.width/4,r.height/4));var p=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35]);t.uniform3fv(i.uniformLocations.ssaoKernel,p),this.screens.forEach((function(e,r){t.activeTexture(e.glTextureNumber),t.bindTexture(t.TEXTURE_2D,e.texture),t.uniform1i(e.textureLocation,r)})),t.activeTexture(this.noiseTextureNumber),t.bindTexture(t.TEXTURE_2D,this.noiseTexture),t.uniform1i(i.uniformLocations.noiseTexture,this.screens.length)},r.prototype.postprocess=function(){var t=this,e=this.gl,r=this.shaderInfo,i=this.globalOptions;e.disable(e.DEPTH_TEST),e.uniform1i(r.uniformLocations.isMain,0),this.screens.forEach((function(o,n){0==n?e.uniform1i(r.uniformLocations.isMain,1):e.uniform1i(r.uniformLocations.isMain,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o.texture),o.texture=t.frameBufferObjs[n].texture,!i.debugMode&&o.forDebug||o.render(e,r,[])})),e.enable(e.DEPTH_TEST)},r}(p),E={attributes:["aVertexPosition","aVertexColor","aVertexSelectionColor","aVertexNormal","aTextureCoordinate"],uniforms:["uModelViewMatrix","uProjectionMatrix","uOrthographicMatrix","uObjectMatrix","uRotationMatrix","uNormalMatrix","uPointSize","uPositionType","uNearFar","uTexture","uTextureType"],vertexShaderSource:"\n  attribute vec3 aVertexPosition;\n  attribute vec4 aVertexColor;\n  attribute vec4 aVertexSelectionColor;\n  attribute vec3 aVertexNormal;\n  attribute vec2 aTextureCoordinate;\n  \n  uniform mat4 uModelViewMatrix;\n  uniform mat4 uProjectionMatrix;\n  uniform mat4 uOrthographicMatrix;\n  uniform mat4 uObjectMatrix;\n  uniform mat4 uRotationMatrix;\n  uniform mat4 uNormalMatrix;\n  uniform float uPointSize;\n  uniform vec2 uNearFar;\n\n  varying vec4 vColor;\n  varying vec4 vSelectionColor;\n  varying vec3 vTransformedNormal;\n  varying float vDepth;\n\n  vec4 getOrthoPosition() {\n    vec4 transformedPosition = uObjectMatrix * vec4(aVertexPosition, 1.0);\n    vec4 orthoPosition = uModelViewMatrix * vec4(transformedPosition.xyz, 1.0);\n    return orthoPosition;\n  }\n  vec3 getRotatedNormal() {\n    vec3 rotatedModelNormal = (uRotationMatrix * vec4(aVertexNormal, 1.0)).xyz;\n    vec3 rotatedNormal = normalize(uNormalMatrix * vec4(rotatedModelNormal, 1.0)).xyz;\n    return rotatedNormal;\n  }\n  float calcDepth(float zValue) {\n    return -(zValue / uNearFar.y);\n  }\n\n  void main(void) {\n    vColor = aVertexColor;\n    vSelectionColor = aVertexSelectionColor;\n    gl_PointSize = uPointSize;\n\n    vec4 orthoPosition = getOrthoPosition();\n    vTransformedNormal = getRotatedNormal();\n\n    vDepth = calcDepth(orthoPosition.z);\n    gl_Position = uOrthographicMatrix * orthoPosition;\n  }\n",fragmentShaderSource:"\n  precision highp float;\n\n  varying vec4 vColor;\n  varying vec4 vSelectionColor;\n  varying vec3 vTransformedNormal;\n  varying float vDepth;\n\n  uniform sampler2D uTexture;\n  uniform int uTextureType;\n\n  vec4 packDepth(float depth) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vDepth;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n  }\n  \n  void main(void) {\n    gl_FragColor = packDepth(vDepth);\n    //gl_FragColor = vec4(vColor.xyz, vColor.a);\n  }\n"},T=function(t){function r(e,r,i,o,n,a,s){var u=t.call(this,e,r,i)||this;return u.camera=o,u.sun=s,u.frameBufferObjs=n,u.renderableList=a,u}return c(r,t),r.prototype.preprocess=function(){},r.prototype.process=function(){var t=this,r=this.gl,i=this.shaderInfo,n=this.globalOptions;this.shader.useProgram(),r.viewport(0,0,8182,8182);var a=e.create();e.perspective(a,this.camera.fovyRadian,n.aspect,n.near,n.far);var s=e.create();e.ortho(s,-8192,8192,-8192,8192,0,8192),r.uniform2fv(i.uniformLocations.nearFar,o.fromValues(0,8192));var u=this.sun.getModelViewMatrix();r.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,a),r.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,u),r.uniformMatrix4fv(i.uniformLocations.orthographicMatrix,!1,s),this.frameBufferObjs.forEach((function(t){t.clear()})),this.renderableList.get().forEach((function(e){void 0===e.getId()&&e.createRenderableObjectId(t.renderableList),e.render(r,i,t.frameBufferObjs)}))},r.prototype.postprocess=function(){},r}(p);Math.degree=function(t){return 180*t/Math.PI},Math.radian=function(t){return t*Math.PI/180},Math.randomInt=function(){return Math.round(10*Math.random())},Array.prototype.get=function(t){return this[this.loopIndex(t)]},Array.prototype.getPrev=function(t){return this[this.loopIndex(t-1)]},Array.prototype.getNext=function(t){return this[this.loopIndex(t+1)]},Array.prototype.loopIndex=function(t){return t<0?t%this.length+this.length:t%this.length};var M=function(){function e(t,e){void 0===e&&(e={}),this.frameBufferObjs=[],this.defaultFrameBufferObjs=[],this.lightMapFrameBufferObjs=[],this.renderableObjectList=new f,this.shaderProcesses=[],this.globalOptions=e,this._canvas=t,this.init()}return e.prototype.init=function(){console.log("Init Start WebGL.");var t="";try{var e=this._canvas;if(e.getContext("webgl2")?(this.gl=e.getContext("webgl2"),t="webgl2"):e.getContext("webgl")&&(this.gl=e.getContext("webgl"),t="webgl"),!this.gl)throw new Error("Unable to initialize WebGL. Your browser may not support it.")}catch(t){console.log("Unable to initialize WebGL. Your browser may not support it."),console.error(t)}console.log("Init Success "+t)},e.prototype.checkMultiRenders=function(){return!this._gl.getExtension("WEBGL_draw_buffers")},e.prototype.resizeCanvas=function(){var t=this.canvas,e=t.clientWidth,r=t.clientHeight,i=t.width!==e||t.height!==r;return i&&(t.width=e,t.height=r,this.frameBufferObjs.forEach((function(t){t.options.isNotInit||t.init()})),console.log("resizeCanvas")),this.globalOptions.aspect=t.width/t.height,i},e.prototype.startRender=function(){var e=this.gl;e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),this.resizeCanvas(),this.defaultShader=new n(e),this.checkMultiRenders()&&this.defaultShader.init(h),this.defaultShaderInfo=this.defaultShader.shaderInfo,this.screenShader=new n(e),this.screenShader.init(m),this.screenShaderInfo=this.screenShader.shaderInfo,this.lightMapShader=new n(e),this.lightMapShader.init(E),this.lightMapShaderInfo=this.lightMapShader.shaderInfo,this.camera=new a({fovyDegree:this.globalOptions.fovyDegree}),this.sun=new s({position:{x:0,y:0,z:4096}}),this.sun.rotationOrbit(.5,.8,t.fromValues(0,0,0)),this.frameBufferObjs.push(this.getMainFbo()),this.frameBufferObjs.push(this.getAlbedoFbo()),this.frameBufferObjs.push(this.getSelectionFbo()),this.frameBufferObjs.push(this.getNormalFbo()),this.frameBufferObjs.push(this.getDepthFbo()),this.frameBufferObjs.push(this.getLightMapFbo()),this.defaultFrameBufferObjs=[],this.defaultFrameBufferObjs.push(this.getMainFbo()),this.defaultFrameBufferObjs.push(this.getAlbedoFbo()),this.defaultFrameBufferObjs.push(this.getSelectionFbo()),this.defaultFrameBufferObjs.push(this.getNormalFbo()),this.defaultFrameBufferObjs.push(this.getDepthFbo()),this.lightMapFrameBufferObjs.push(this.getLightMapFbo()),this.shaderProcesses.push(new d(e,this.defaultShader,this.globalOptions,this.camera,this.defaultFrameBufferObjs,this.renderableObjectList)),this.shaderProcesses.push(new T(e,this.lightMapShader,this.globalOptions,this.camera,this.lightMapFrameBufferObjs,this.renderableObjectList,this.sun)),this.shaderProcesses.push(new B(e,this.screenShader,this.globalOptions,this.camera,this.frameBufferObjs,this.sun)),this.shaderProcesses.forEach((function(t){t.preprocess()})),this.render()},e.prototype.setOptions=function(){this.resizeCanvas(),this.camera.syncFovyDegree(this.globalOptions.fovyDegree),this.globalOptions.cullFace?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.globalOptions.depthTest?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST)},e.prototype.render=function(){this.scene(),requestAnimationFrame(this.render.bind(this))},e.prototype.scene=function(){var t=this;this.setOptions(),this.shaderProcesses.forEach((function(e){e.process(t.globalOptions)})),this.shaderProcesses.forEach((function(e){e.postprocess(t.globalOptions)}))},e.prototype.getMainFbo=function(){var e=t.fromValues(.2,.2,.2);return this.mainFbo||(this.mainFbo=new u(this.gl,this.canvas,this.defaultShaderInfo,{name:"main",textureType:1,clearColor:e},this.globalOptions)),this.mainFbo},e.prototype.getAlbedoFbo=function(){return this.albedoFbo||(this.albedoFbo=new u(this.gl,this.canvas,this.defaultShaderInfo,{name:"albedo",textureType:1},this.globalOptions)),this.albedoFbo},e.prototype.getSelectionFbo=function(){return this.selectionFbo||(this.selectionFbo=new u(this.gl,this.canvas,this.defaultShaderInfo,{name:"selection",textureType:2},this.globalOptions)),this.selectionFbo},e.prototype.getDepthFbo=function(){return this.depthFbo||(this.depthFbo=new u(this.gl,this.canvas,this.defaultShaderInfo,{name:"depth",textureType:3},this.globalOptions)),this.depthFbo},e.prototype.getNormalFbo=function(){return this.normalFbo||(this.normalFbo=new u(this.gl,this.canvas,this.defaultShaderInfo,{name:"normal",textureType:4},this.globalOptions)),this.normalFbo},e.prototype.getLightMapFbo=function(){return this.lightMapFbo||(this.lightMapFbo=new u(this.gl,this.canvas,this.defaultShaderInfo,{name:"light",textureType:5,width:8182,height:8182},this.globalOptions)),this.lightMapFbo},Object.defineProperty(e.prototype,"gl",{get:function(){return this._gl},set:function(t){this._gl=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},set:function(t){this._canvas=t},enumerable:!1,configurable:!0}),e}(),A=function(){function t(){}return t.calcTextureCoordinate=function(t,e,i){var o=i*e[0],n=i*e[1],a=i*e[0]+i,s=i*e[1]+i;if(o<0||n<0||a>t[0]||s>t[1])throw new Error("incorrect texture coordinate.");return r.fromValues(o/t[0],n/t[1],a/t[0],s/t[1])},t}(),V=function(e){function i(t){var r=e.call(this)||this;return r.init(t),r}return c(i,e),i.prototype.init=function(e){this.texturePosition=o.fromValues(0,0),this.size=t.fromValues(128,128,128),this.name="Untitled Cube",(null==e?void 0:e.name)&&(this.name=e.name),(null==e?void 0:e.position)&&(this.position=t.set(this.position,e.position.x,e.position.y,e.position.z)),(null==e?void 0:e.size)&&(this.size=t.set(this.size,e.size.width,e.size.length,e.size.height)),(null==e?void 0:e.rotation)&&(this.rotation=t.set(this.rotation,e.rotation.pitch,e.rotation.roll,e.rotation.heading)),(null==e?void 0:e.color)&&(this.color=r.set(this.color,null==e?void 0:e.color.r,null==e?void 0:e.color.g,null==e?void 0:e.color.b,null==e?void 0:e.color.a)),(null==e?void 0:e.texture)&&(this.texture=e.texture),(null==e?void 0:e.texturePosition)&&(this.texturePosition=e.texturePosition),(null==e?void 0:e.image)&&(this.image=e.image)},i.prototype.render=function(t,e,r){var i=this.getTransformMatrix(),o=this.getRotationMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,i),t.uniformMatrix4fv(e.uniformLocations.rotationMatrix,!1,o);var n=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.indicesGlBuffer),t.enableVertexAttribArray(e.attributeLocations.vertexNormal),n.bindBuffer(n.normalGlBuffer,3,e.attributeLocations.vertexNormal),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),n.bindBuffer(n.positionsGlBuffer,3,e.attributeLocations.vertexPosition),t.enableVertexAttribArray(e.attributeLocations.vertexColor),n.bindBuffer(n.colorGlBuffer,4,e.attributeLocations.vertexColor),t.enableVertexAttribArray(e.attributeLocations.vertexSelectionColor),n.bindBuffer(n.selectionColorGlBuffer,4,e.attributeLocations.vertexSelectionColor),r.forEach((function(r){r.bind(e),1==r.textureType&&(t.bindTexture(t.TEXTURE_2D,n.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),n.bindBuffer(n.textureGlBuffer,2,e.attributeLocations.textureCoordinate)),t.drawElements(t.TRIANGLES,n.indicesLength,t.UNSIGNED_SHORT,0),r.unbind()}))},i.prototype.getBuffer=function(e){if(void 0===this.buffer){this.buffer=new b(e),this.texture&&(this.buffer.texture=this.texture,this.textureSize=o.fromValues(512,512));var r=this.size[0]/2,i=this.size[1]/2,n=this.size[2],a=this.color,s=t.fromValues(-r,-i,0),u=t.fromValues(r,-i,0),f=t.fromValues(r,i,0),h=t.fromValues(-r,i,0),l=t.fromValues(-r,-i,n),c=t.fromValues(r,-i,n),p=t.fromValues(r,i,n),d=t.fromValues(-r,i,n),m=this.normal(s,f,u),v=this.normal(s,h,f),x=this.normal(l,c,p),g=this.normal(l,p,d),y=this.normal(h,s,l),B=this.normal(h,l,d),E=this.normal(u,f,p),T=this.normal(u,p,c),M=this.normal(s,u,c),V=this.normal(s,c,l),C=this.normal(f,h,d),O=this.normal(f,d,p),S=this.selectionColor;this.buffer.positionsVBO=new Float32Array([s[0],s[1],s[2],f[0],f[1],f[2],u[0],u[1],u[2],s[0],s[1],s[2],h[0],h[1],h[2],f[0],f[1],f[2],l[0],l[1],l[2],c[0],c[1],c[2],p[0],p[1],p[2],l[0],l[1],l[2],p[0],p[1],p[2],d[0],d[1],d[2],h[0],h[1],h[2],s[0],s[1],s[2],l[0],l[1],l[2],h[0],h[1],h[2],l[0],l[1],l[2],d[0],d[1],d[2],u[0],u[1],u[2],f[0],f[1],f[2],p[0],p[1],p[2],u[0],u[1],u[2],p[0],p[1],p[2],c[0],c[1],c[2],s[0],s[1],s[2],u[0],u[1],u[2],c[0],c[1],c[2],s[0],s[1],s[2],c[0],c[1],c[2],l[0],l[1],l[2],f[0],f[1],f[2],h[0],h[1],h[2],d[0],d[1],d[2],f[0],f[1],f[2],d[0],d[1],d[2],p[0],p[1],p[2]]),this.buffer.normalVBO=new Float32Array([m[0],m[1],m[2],m[0],m[1],m[2],m[0],m[1],m[2],v[0],v[1],v[2],v[0],v[1],v[2],v[0],v[1],v[2],x[0],x[1],x[2],x[0],x[1],x[2],x[0],x[1],x[2],g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2],y[0],y[1],y[2],y[0],y[1],y[2],y[0],y[1],y[2],B[0],B[1],B[2],B[0],B[1],B[2],B[0],B[1],B[2],E[0],E[1],E[2],E[0],E[1],E[2],E[0],E[1],E[2],T[0],T[1],T[2],T[0],T[1],T[2],T[0],T[1],T[2],M[0],M[1],M[2],M[0],M[1],M[2],M[0],M[1],M[2],V[0],V[1],V[2],V[0],V[1],V[2],V[0],V[1],V[2],C[0],C[1],C[2],C[0],C[1],C[2],C[0],C[1],C[2],O[0],O[1],O[2],O[0],O[1],O[2],O[0],O[1],O[2]]),this.buffer.colorVBO=new Float32Array([a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3],a[0],a[1],a[2],a[3]]),this.buffer.selectionColorVBO=new Float32Array([S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3]]);var R=A.calcTextureCoordinate(this.textureSize,this.texturePosition,16),F=[];this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO);var L=this.buffer.positionsVBO.length/3,_=new Uint16Array(L);this.buffer.indicesVBO=_.map((function(t,e){return F.push(R[0]),F.push(R[1]),F.push(R[2]),F.push(R[1]),F.push(R[2]),F.push(R[3]),F.push(R[0]),F.push(R[1]),F.push(R[2]),F.push(R[3]),F.push(R[0]),F.push(R[3]),e})),this.buffer.textureVBO=new Float32Array(F),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length}return this.buffer},i}(v),C=function(){function e(){}return e.tessellate=function(t,e){var r=this;void 0===e&&(e=!0);var i=[];return this.validateConvex(t).forEach((function(t){var o=r.toTriangles(t,e);i=i.concat(o)})),i},e.validateConvex=function(t,e){var r=this;if(void 0===e&&(e=[]),this.isConvex(t))e.push(t);else{var i=t.find((function(e,i){return r.getPositionNormal(t,i)<0}));if(void 0===i)return e;var o=t.indexOf(i);this.sortedNearest(t,o).some((function(o){if(void 0===i)return e;var n=r.split(t,i,o);return!r.validateIntersection(t,i,o)&&(r.validateAngle(n[0])===r.validateAngle(n[1])?(r.validateConvex(n[0],e),r.validateConvex(n[1],e),!0):void 0)}))}return e},e.validateIntersection=function(t,e,r){var i=this;return void 0!==t.find((function(o,n){var a=t.get(n),s=t.getNext(n);if(i.intersection(e,r,a,s))return!0}))},e.isConvex=function(t){var e=this;return void 0===t.find((function(r,i){return e.getPositionNormal(t,i)<0}))},e.toTriangles=function(t,e){void 0===e&&(e=!0);for(var r=t.length,i=[],o=1;o<r-1;o++)e?i.push(new g(t[0],t[o],t[o+1])):i.push(new g(t[0],t[o+1],t[o]));return i},e.split=function(t,e,r){return[this.createSplits(t,e,r),this.createSplits(t,r,e)]},e.createSplits=function(t,e,r){var i=[];i.push(e),i.push(r);for(var o=t.indexOf(r),n=0;n<t.length-1;n++){var a=t.get(o),s=t.getNext(o);if(s==e||s==r)break;this.compare(a,s)||i.push(s),o++}return i},e.validateCCW=function(t){var e=this,r=0;return t.forEach((function(i,o){var n=e.getPositionNormal(t,o),a=Math.degree(e.getAngle(t,o));n>=0?r+=a:r-=a})),r},e.validateAngle=function(t){var e=this,r=0,i=0;return t.forEach((function(o,n){var a=e.getPositionNormal(t,n),s=Math.degree(e.getAngle(t,n));a>0?r+=s:i+=s})),r>i},e.getPositionNormal=function(t,e){var r=t.getPrev(e),i=t.get(e),o=t.getNext(e);return this.normal(r,i,o)[2]},e.getAngle=function(e,r){var i=e.getPrev(r),o=e.get(r),n=e.getNext(r),a=t.subtract(t.create(),o,i),s=t.subtract(t.create(),n,o);return t.angle(a,s)},e.sortedNearest=function(e,r){var i=e.getPrev(r),o=e.get(r),n=e.getNext(r);return e.filter((function(t){return!(t==i||t==o||t==n)})).sort((function(e,r){var i=t.squaredDistance(o,e),n=t.squaredDistance(o,r);return i<n?-1:i>n?1:0}))},e.intersection=function(e,r,i,o){var n=t.dot(this.cross(e,r,i),this.cross(e,r,o)),a=t.dot(this.cross(i,o,e),this.cross(i,o,r));return(0!=n||0!=a)&&(n<=0&&a<=0)},e.compare=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},e.cross=function(e,r,i){var o=t.subtract(t.create(),r,e),n=t.subtract(t.create(),i,r);return t.cross(t.create(),o,n)},e.normal=function(e,r,i){var o=this.cross(e,r,i);return t.normalize(o,o)},e}(),O=function(e){function i(t,r){var i=e.call(this)||this;return i.init(t,r),i}return c(i,e),i.prototype.init=function(e,i){this.triangles=[],this.height=3,this.name="Untitled Polygon",e&&(this.coordinates=e),(null==i?void 0:i.name)&&(this.name=i.name),(null==i?void 0:i.height)&&(this.height=i.height),(null==i?void 0:i.position)&&(this.position=t.set(this.position,i.position.x,i.position.y,i.position.z)),(null==i?void 0:i.rotation)&&(this.rotation=t.set(this.rotation,i.rotation.pitch,i.rotation.roll,i.rotation.heading)),(null==i?void 0:i.color)&&(this.color=r.set(this.color,null==i?void 0:i.color.r,null==i?void 0:i.color.g,null==i?void 0:i.color.b,null==i?void 0:i.color.a)),(null==i?void 0:i.texture)&&(this.texture=i.texture),(null==i?void 0:i.image)&&(this.image=i.image)},i.prototype.render=function(t,e,r){var i=this.getTransformMatrix(),o=this.getRotationMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,i),t.uniformMatrix4fv(e.uniformLocations.rotationMatrix,!1,o);var n=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.indicesGlBuffer),t.enableVertexAttribArray(e.attributeLocations.vertexNormal),n.bindBuffer(n.normalGlBuffer,3,e.attributeLocations.vertexNormal),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),n.bindBuffer(n.positionsGlBuffer,3,e.attributeLocations.vertexPosition),t.enableVertexAttribArray(e.attributeLocations.vertexColor),n.bindBuffer(n.colorGlBuffer,4,e.attributeLocations.vertexColor),t.enableVertexAttribArray(e.attributeLocations.vertexSelectionColor),n.bindBuffer(n.selectionColorGlBuffer,4,e.attributeLocations.vertexSelectionColor),r.forEach((function(r){var i=r.textureType;r.bind(e),1==i&&(t.bindTexture(t.TEXTURE_2D,n.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),n.bindBuffer(n.textureGlBuffer,2,e.attributeLocations.textureCoordinate)),t.drawElements(t.TRIANGLES,n.indicesLength,t.UNSIGNED_SHORT,0),r.unbind()}))},i.prototype.getBuffer=function(e){var r=this;if(void 0===this.buffer||!0===this.dirty){this.buffer=new b(e);var i=this.color,o=this.selectionColor,n=[],a=[],s=[],u=[],f=[],h=this.coordinates.map((function(e){return t.fromValues(e[0],e[1],r.height)})),l=this.coordinates.map((function(e){return t.fromValues(e[0],e[1],0)})),c=this.getMinMax(h);c.minz=0,c.maxz=this.height,C.validateCCW(h)<0&&(h.reverse(),l.reverse());var p=C.tessellate(h),d=C.tessellate(l,!1),m=this.createSideTriangle(h,l,!0),v=[];v=(v=(v=v.concat(p)).concat(d)).concat(m),this.triangles=v,v.forEach((function(t){var e=t.positions,r=t.getNormal();e.forEach((function(t){t.forEach((function(t){return s.push(t)})),r.forEach((function(t){return u.push(t)})),i.forEach((function(t){return n.push(t)})),o.forEach((function(t){return a.push(t)}));var e=c.maxx-c.minx,h=c.maxy-c.miny,l=c.maxz-c.minz;1==r[0]||-1==r[0]?(f.push((t[1]-c.miny)/h),f.push((t[2]-c.minz)/l)):1==r[1]||-1==r[1]?(f.push((t[0]-c.minx)/e),f.push((t[2]-c.minz)/l)):1!=r[2]&&-1!=r[2]||(f.push((t[0]-c.minx)/e),f.push((t[1]-c.miny)/h))}))}));var x=new Uint16Array(s.length/3);this.buffer.indicesVBO=x.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(s),this.buffer.normalVBO=new Float32Array(u),this.buffer.colorVBO=new Float32Array(n),this.buffer.selectionColorVBO=new Float32Array(a),this.buffer.textureVBO=new Float32Array(f),this.texture?this.buffer.texture=this.texture:this.image&&(this.buffer.texture=this.buffer.createTexture(this.image)),this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},i.prototype.createSideTriangle=function(t,e,r){void 0===r&&(r=!0);var i=[];if(t.length!=e.length)throw new Error("plane length is not matched.");for(var o=t.length,n=0;n<o;n++){var a=t.getPrev(n),s=t.get(n),u=e.getPrev(n),f=e.get(n);r?(i.push(new g(s,a,u)),i.push(new g(s,u,f))):(i.push(new g(s,u,a)),i.push(new g(s,f,u)))}return i},i.prototype.createRandomColor=function(){var t=Math.round(10*Math.random())/10,e=Math.round(10*Math.random())/10,i=Math.round(10*Math.random())/10;return r.fromValues(t,e,i,1)},i}(v),S=function(e){function i(t,r){var i=e.call(this)||this;return i.init(t,r),i}return c(i,e),i.prototype.init=function(e,i){this.length=0,this.name="Untitled Rectangle",(null==i?void 0:i.id)&&(this.id=i.id,this.selectionColor=this.convertIdToColor(i.id)),e&&(this.coordinates=e),(null==i?void 0:i.position)&&(this.position=t.set(this.position,i.position.x,i.position.y,i.position.z)),(null==i?void 0:i.color)&&(this.color=r.set(this.color,null==i?void 0:i.color.r,null==i?void 0:i.color.g,null==i?void 0:i.color.b,null==i?void 0:i.color.a)),(null==i?void 0:i.texture)&&(this.texture=i.texture),(null==i?void 0:i.image)&&!(null==i?void 0:i.texture)&&(this.image=i.image)},i.prototype.render=function(t,e,r){var i=this,o=this.getTransformMatrix(),n=this.getRotationMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,o),t.uniformMatrix4fv(e.uniformLocations.rotationMatrix,!1,n);var a=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.indicesGlBuffer),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),a.bindBuffer(a.postionsGlBuffer,3,e.attributeLocations.vertexPosition),t.enableVertexAttribArray(e.attributeLocations.vertexNormal),a.bindBuffer(a.normalGlBuffer,3,e.attributeLocations.vertexNormal),t.enableVertexAttribArray(e.attributeLocations.vertexColor),a.bindBuffer(a.colorGlBuffer,4,e.attributeLocations.vertexColor),t.enableVertexAttribArray(e.attributeLocations.vertexSelectionColor),a.bindBuffer(a.selectionColorGlBuffer,4,e.attributeLocations.vertexSelectionColor),r.forEach((function(r){r.bind(e),(i.image||i.texture)&&(t.bindTexture(t.TEXTURE_2D,a.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),a.bindBuffer(a.textureGlBuffer,2,e.attributeLocations.textureCoordinate)),t.drawElements(t.TRIANGLES,a.indicesLength,t.UNSIGNED_SHORT,0),r.unbind()}))},i.prototype.getBuffer=function(e){var r=this;if(this.dirty=void 0===this.buffer||this.length!=this.coordinates.length,!0===this.dirty){this.buffer=new b(e);var i=this.color,o=this.selectionColor,n=[],a=[],s=[],u=[],f=[],h=this.coordinates.map((function(e){return t.fromValues(e[0],e[1],r.position[2])})),l=this.getMinMax(h);[new g(h[0],h[1],h[2]),new g(h[0],h[2],h[3])].forEach((function(t){var e=t.positions,r=t.getNormal();e.forEach((function(t){t.forEach((function(t){s.push(t)})),r.forEach((function(t){return u.push(t)})),i.forEach((function(t){return n.push(t)})),o.forEach((function(t){return a.push(t)}));var e=l.maxx-l.minx,h=l.maxy-l.miny;f.push((t[0]-l.minx)/e),f.push((t[1]-l.miny)/h)}))})),this.length=this.coordinates.length;var c=new Uint16Array(s.length/3);if(this.buffer.indicesVBO=c.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(s),this.buffer.colorVBO=new Float32Array(n),this.buffer.selectionColorVBO=new Float32Array(a),this.buffer.normalVBO=new Float32Array(u),this.buffer.textureVBO=new Float32Array(f),this.texture)this.buffer.texture=this.texture;else if(!this.texture&&this.image){var p=this.buffer.createTexture(this.image);this.buffer.texture=p,this.texture=p}this.buffer.postionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},i}(v),R=function(e){function i(t){var r=e.call(this)||this;return r.init(t),r}return c(i,e),i.prototype.init=function(e){this.name="Untitled Point",(null==e?void 0:e.height)&&(this.height=e.height),(null==e?void 0:e.position)&&(this.position=t.set(this.position,e.position.x,e.position.y,e.position.z)),(null==e?void 0:e.color)&&(this.color=r.set(this.color,null==e?void 0:e.color.r,null==e?void 0:e.color.g,null==e?void 0:e.color.b,null==e?void 0:e.color.a))},i.prototype.render=function(t,e,r){var i=this.getTransformMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,i);var o=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o.indicesGlBuffer),r.forEach((function(r){var i=r.textureType;r.bind(),4==i?(t.enableVertexAttribArray(e.attributeLocations.vertexColor),o.bindBuffer(o.selectionColorGlBuffer,4,e.attributeLocations.vertexColor)):(t.enableVertexAttribArray(e.attributeLocations.vertexColor),o.bindBuffer(o.colorGlBuffer,4,e.attributeLocations.vertexColor)),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),o.bindBuffer(o.positionsGlBuffer,3,e.attributeLocations.vertexPosition),t.disable(t.DEPTH_TEST),t.drawElements(t.POINTS,o.indicesLength,t.UNSIGNED_SHORT,0),t.enable(t.DEPTH_TEST),r.unbind()}))},i.prototype.getBuffer=function(t){if(void 0===this.buffer||!0===this.dirty){this.buffer=new b(t);var e=[],r=[],i=[];this.position.forEach((function(t){return i.push(t)})),this.color.forEach((function(t){return e.push(t)})),this.selectionColor.forEach((function(t){return r.push(t)}));var o=new Uint16Array(i.length);this.buffer.indicesVBO=o.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(i),this.buffer.colorVBO=new Float32Array(e),this.buffer.selectionColorVBO=new Float32Array(r),this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},i}(v),F=function(t){function e(e,r){var i=t.call(this)||this;return i.init(e,r),i}return c(e,t),e.prototype.init=function(t,e){this.length=0,this.name="Untitled Line",t&&(this.coordinates=t),(null==e?void 0:e.height)&&(this.height=e.height),(null==e?void 0:e.color)&&(this.color=r.set(this.color,null==e?void 0:e.color.r,null==e?void 0:e.color.g,null==e?void 0:e.color.b,null==e?void 0:e.color.a))},e.prototype.render=function(t,e,r){var i=this.getTransformMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,i);var o=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o.indicesGlBuffer),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),t.enableVertexAttribArray(e.attributeLocations.vertexColor),t.disable(t.DEPTH_TEST),t.drawElements(t.LINE_STRIP,o.indicesLength,t.UNSIGNED_SHORT,0),t.enable(t.DEPTH_TEST)},e.prototype.getBuffer=function(t){var e=this;if(void 0===this.buffer||this.length!=this.coordinates.length||!0===this.dirty){this.buffer=new b(t);var r=[],i=[],o=[];this.coordinates.forEach((function(t){t.forEach((function(t){return o.push(t)})),e.color.forEach((function(t){return r.push(t)})),e.selectionColor.forEach((function(t){return i.push(t)}))})),this.length=this.coordinates.length;var n=new Uint16Array(this.length);this.buffer.indicesVBO=n.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(o),this.buffer.colorVBO=new Float32Array(r),this.buffer.selectionColorVBO=new Float32Array(i),this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},e}(v),L=function(i){function n(t){var e=i.call(this)||this;return e.init(t),e}return c(n,i),n.prototype.init=function(e){this.triangles=[],this.radius=1,this.height=3,this.density=36,this.name="Untitled Cylinder",(null==e?void 0:e.radius)&&(this.radius=e.radius),(null==e?void 0:e.height)&&(this.height=e.height),(null==e?void 0:e.density)&&(this.density=e.density),(null==e?void 0:e.position)&&(this.position=t.set(this.position,e.position.x,e.position.y,e.position.z)),(null==e?void 0:e.rotation)&&(this.rotation=t.set(this.rotation,e.rotation.pitch,e.rotation.roll,e.rotation.heading)),(null==e?void 0:e.color)&&(this.color=r.set(this.color,null==e?void 0:e.color.r,null==e?void 0:e.color.g,null==e?void 0:e.color.b,null==e?void 0:e.color.a)),(null==e?void 0:e.image)&&(this.image=e.image)},n.prototype.rotate=function(r,i,o){var n=t.fromValues(1,0,0),a=e.fromRotation(e.create(),i,n);return e.multiply(o,o,a)},n.prototype.render=function(t,e,r){var i=this,o=this.getTransformMatrix(),n=this.getRotationMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,o),t.uniformMatrix4fv(e.uniformLocations.rotationMatrix,!1,n);var a=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.indicesGlBuffer),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),a.bindBuffer(a.positionsGlBuffer,3,e.attributeLocations.vertexPosition),t.enableVertexAttribArray(e.attributeLocations.vertexNormal),a.bindBuffer(a.normalGlBuffer,3,e.attributeLocations.vertexNormal),t.enableVertexAttribArray(e.attributeLocations.vertexColor),a.bindBuffer(a.colorGlBuffer,4,e.attributeLocations.vertexColor),t.enableVertexAttribArray(e.attributeLocations.vertexSelectionColor),a.bindBuffer(a.selectionColorGlBuffer,4,e.attributeLocations.vertexSelectionColor),r.forEach((function(r){r.bind(),(i.image||i.texture)&&(t.bindTexture(t.TEXTURE_2D,a.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),a.bindBuffer(a.textureGlBuffer,2,e.attributeLocations.textureCoordinate)),t.drawElements(t.TRIANGLES,a.indicesLength,t.UNSIGNED_SHORT,0),r.unbind()}))},n.prototype.getBuffer=function(e){var r=this;if(void 0===this.buffer||!0===this.dirty){this.buffer=new b(e);var i=this.color,n=this.selectionColor,a=[],s=[],u=[],f=[],h=[];this.coordinates=[];for(var l=360/this.density,c=o.fromValues(0,0),p=o.fromValues(0,0+this.radius),d=0;d<this.density;d++){var m=Math.radian(d*l),v=o.rotate(o.create(),p,c,m);this.coordinates.push(v)}var x=this.coordinates.map((function(e){return t.fromValues(e[0],e[1],r.height)})),y=this.coordinates.map((function(e){return t.fromValues(e[0],e[1],0)})),B=this.getMinMax(x);B.minz=this.position[2],B.maxz=this.position[2]+this.height,C.validateCCW(x)<0&&(x.reverse(),y.reverse());var E=t.fromValues(0,0,this.height),T=x.map((function(t,e){var r=x.getNext(e);return new g(E,t,r)})),M=t.fromValues(0,0,0),A=y.map((function(t,e){var r=y.getNext(e);return new g(M,r,t)})),V=this.createSideTriangle(x,y,!0),O=[];O=(O=(O=O.concat(T)).concat(A)).concat(V),this.triangles=O,O.forEach((function(t){var e=t.positions,r=t.getNormal();e.forEach((function(t){t.forEach((function(t){return u.push(t)})),r.forEach((function(t){return f.push(t)})),i.forEach((function(t){return a.push(t)})),n.forEach((function(t){return s.push(t)}));var e=B.maxx-B.minx,o=B.maxy-B.miny,l=B.maxz-B.minz;1==r[0]||-1==r[0]?(h.push((t[1]-B.miny)/o),h.push((t[2]-B.minz)/l)):1==r[1]||-1==r[1]?(h.push((t[0]-B.minx)/e),h.push((t[2]-B.minz)/l)):1!=r[2]&&-1!=r[2]||(h.push((t[0]-B.minx)/e),h.push((t[1]-B.miny)/o))}))}));var S=new Uint16Array(u.length);if(this.buffer.indicesVBO=S.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(u),this.buffer.normalVBO=new Float32Array(f),this.buffer.colorVBO=new Float32Array(a),this.buffer.selectionColorVBO=new Float32Array(s),this.buffer.textureVBO=new Float32Array(h),this.image){var R=this.buffer.createTexture(this.image);this.buffer.texture=R,this.texture=R}this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},n.prototype.createSideTriangle=function(t,e,r){void 0===r&&(r=!0);var i=[];if(t.length!=e.length)throw new Error("plane length is not matched.");for(var o=t.length,n=0;n<o;n++){var a=t.getPrev(n),s=t.get(n),u=e.getPrev(n),f=e.get(n);r?(i.push(new g(s,a,u)),i.push(new g(s,u,f))):(i.push(new g(s,u,a)),i.push(new g(s,f,u)))}return i},n.prototype.createRandomColor=function(){var t=Math.round(10*Math.random())/10,e=Math.round(10*Math.random())/10,i=Math.round(10*Math.random())/10;return r.fromValues(t,e,i,1)},n}(v),_=function(e){function i(t,r){var i=e.call(this)||this;return i.init(t,r),i}return c(i,e),i.prototype.init=function(e,i){this.triangles=[],this.radius=1,this.height=3,this.scale=1,this.name="Untitled OBJ File",(null==e?void 0:e.radius)&&(this.radius=e.radius),(null==e?void 0:e.height)&&(this.height=e.height),(null==e?void 0:e.position)&&(this.position=t.set(this.position,e.position.x,e.position.y,e.position.z)),(null==e?void 0:e.rotation)&&(this.rotation=t.set(this.rotation,e.rotation.pitch,e.rotation.roll,e.rotation.heading)),(null==e?void 0:e.color)&&(this.color=r.set(this.color,null==e?void 0:e.color.r,null==e?void 0:e.color.g,null==e?void 0:e.color.b,null==e?void 0:e.color.a)),(null==e?void 0:e.image)&&(this.image=e.image),(null==e?void 0:e.scale)&&(this.scale=e.scale),this.objData=i},i.prototype.render=function(t,e,r){var i=this,o=this.getTransformMatrix(),n=this.getRotationMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,o),t.uniformMatrix4fv(e.uniformLocations.rotationMatrix,!1,n);var a=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.indicesGlBuffer),t.enableVertexAttribArray(e.attributeLocations.vertexPosition),a.bindBuffer(a.positionsGlBuffer,3,e.attributeLocations.vertexPosition),t.enableVertexAttribArray(e.attributeLocations.vertexNormal),a.bindBuffer(a.normalGlBuffer,3,e.attributeLocations.vertexNormal),t.enableVertexAttribArray(e.attributeLocations.vertexColor),a.bindBuffer(a.colorGlBuffer,4,e.attributeLocations.vertexColor),t.enableVertexAttribArray(e.attributeLocations.vertexSelectionColor),a.bindBuffer(a.selectionColorGlBuffer,4,e.attributeLocations.vertexSelectionColor),r.forEach((function(r){r.bind(),(i.image||i.texture)&&(t.bindTexture(t.TEXTURE_2D,a.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),a.bindBuffer(a.textureGlBuffer,2,e.attributeLocations.textureCoordinate)),t.drawElements(t.TRIANGLES,a.indicesLength,t.UNSIGNED_SHORT,0),r.unbind()}))},i.prototype.getBuffer=function(e){if(void 0===this.buffer||!0===this.dirty){this.buffer=new b(e);var r=this.color,i=this.selectionColor,o=[],n=[],a=[],s=[],u=[],f=this.objData,h=this.scale,l=[];f.vertices.forEach((function(e){var r=e.split(" ").filter((function(t){return""!==t})),i=parseFloat(r[0])*h,o=parseFloat(r[1])*h,n=parseFloat(r[2])*h;u.push(t.fromValues(i,n,o))}));var c=[];f.allVertices.forEach((function(e){var r=e.split(" ").filter((function(t){return""!==t})),i=parseFloat(r[0])*h,o=parseFloat(r[1])*h,n=parseFloat(r[2])*h;c.push(t.fromValues(i,n,o))})),f.faces.forEach((function(t){var e=t.split(" ").filter((function(t){return""!==t})),i=e.length;if(i>=3)for(var n=e.map((function(t){return parseInt(t.split("/")[0])})).map((function(t){return t<0?u[u.length+t]:c[t-1]})),a=2;a<i;a++)l.push(new g(n[0],n[a],n[a-1])),r.forEach((function(t){return o.push(t)})),r.forEach((function(t){return o.push(t)})),r.forEach((function(t){return o.push(t)}))})),l.forEach((function(t){var e=t.positions,r=t.getNormal();e.forEach((function(t){t.forEach((function(t){return a.push(t)})),r.forEach((function(t){return s.push(t)})),i.forEach((function(t){return n.push(t)}))}))}));var p=new Uint16Array(a.length);if(this.buffer.indicesVBO=p.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(a),this.buffer.normalVBO=new Float32Array(s),this.buffer.colorVBO=new Float32Array(o),this.buffer.selectionColorVBO=new Float32Array(n),this.buffer.textureVBO=new Float32Array([]),this.image){var d=this.buffer.createTexture(this.image);this.buffer.texture=d,this.texture=d}this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},i}(v),w=function(t){function e(e){var r=t.call(this)||this;return r.init(e),r}return c(e,t),e.prototype.init=function(t){this.name="Untitled BatchObject",this.colors=t.colors,this.selectionColors=t.selectionColors,this.positions=t.positions,this.normals=t.normals,this.textures=t.textures,this.textureCoordinates=t.textureCoordinates},e.prototype.render=function(t,e,r){var i=this.getTransformMatrix(),o=this.getRotationMatrix();t.uniformMatrix4fv(e.uniformLocations.objectMatrix,!1,i),t.uniformMatrix4fv(e.uniformLocations.rotationMatrix,!1,o);var n=this.getBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.indicesGlBuffer),n.normalGlBuffer&&(t.enableVertexAttribArray(e.attributeLocations.vertexNormal),n.bindBuffer(n.normalGlBuffer,3,e.attributeLocations.vertexNormal)),n.positionsGlBuffer&&(t.enableVertexAttribArray(e.attributeLocations.vertexPosition),n.bindBuffer(n.positionsGlBuffer,3,e.attributeLocations.vertexPosition)),n.colorGlBuffer&&(t.enableVertexAttribArray(e.attributeLocations.vertexColor),n.bindBuffer(n.colorGlBuffer,4,e.attributeLocations.vertexColor)),n.selectionColorGlBuffer&&(t.enableVertexAttribArray(e.attributeLocations.vertexSelectionColor),n.bindBuffer(n.selectionColorGlBuffer,4,e.attributeLocations.vertexSelectionColor)),n.textureGlBuffer&&(t.bindTexture(t.TEXTURE_2D,n.texture),t.enableVertexAttribArray(e.attributeLocations.textureCoordinate),n.bindBuffer(n.textureGlBuffer,2,e.attributeLocations.textureCoordinate)),r.forEach((function(e){e.bind(),n.indicesLength&&t.drawElements(t.TRIANGLES,n.indicesLength,t.UNSIGNED_SHORT,0),e.unbind()}))},e.prototype.getBuffer=function(t){if(void 0===this.buffer||!0===this.dirty){this.buffer=new b(t);var e=this.colors,r=this.selectionColors,i=this.positions,o=this.normals,n=this.textureCoordinates,a=this.textures;this.buffer.texture=a[0];var s=new Uint16Array(i.length/3);this.buffer.indicesVBO=s.map((function(t,e){return e})),this.buffer.positionsVBO=new Float32Array(i),this.buffer.normalVBO=new Float32Array(o),this.buffer.colorVBO=new Float32Array(e),this.buffer.selectionColorVBO=new Float32Array(r),this.buffer.textureVBO=new Float32Array(n),this.buffer.positionsGlBuffer=this.buffer.createBuffer(this.buffer.positionsVBO),this.buffer.colorGlBuffer=this.buffer.createBuffer(this.buffer.colorVBO),this.buffer.selectionColorGlBuffer=this.buffer.createBuffer(this.buffer.selectionColorVBO),this.buffer.normalGlBuffer=this.buffer.createBuffer(this.buffer.normalVBO),this.buffer.indicesGlBuffer=this.buffer.createIndexBuffer(this.buffer.indicesVBO),this.buffer.textureGlBuffer=this.buffer.createBuffer(this.buffer.textureVBO),this.buffer.indicesLength=this.buffer.indicesVBO.length,this.dirty=!1}return this.buffer},e}(v);Float32Array.prototype.concat=function(){var t=4,e=Array.prototype.slice.call(arguments);e.unshift(this);var r=(e=e.map((function(e){if(e instanceof Float32Array)return e.buffer;if(e instanceof ArrayBuffer){if(e.byteLength/t%1!=0)throw new Error("One of the ArrayBuffers is not from a Float32Array");return e}throw new Error("You can only concat Float32Array, or ArrayBuffers")}))).map((function(t){return t.byteLength})).reduce((function(t,e){return t+e}),0),i=new Float32Array(r/t),o=0;return e.forEach((function(e){i.set(new Float32Array(e),o),o+=e.byteLength/t})),i};var P=function(){function t(){}return t.batch100=function(t,e){for(var r=[],i=0;i<e.length;i+=500){var o=this.batch(t,e.slice(i,i+500));r.push(o)}return r},t.batch=function(t,e){var r=[],i=[],o=[],n=[],a=[],s=[];e.forEach((function(e){var u=e.position,f=e.getBuffer(t),h=[];f.positionsVBO&&f.positionsVBO.forEach((function(t,e){var r=e%3;0==r?h.push(t+u[0]):1==r?h.push(t+u[1]):h.push(t+u[2])})),r.push(h),f.normalVBO&&i.push(f.normalVBO),f.colorVBO&&o.push(f.colorVBO),f.selectionColorVBO&&n.push(f.selectionColorVBO),f.textureVBO&&a.push(f.textureVBO),f.texture&&s.push(f.texture)}));var u={positions:this.concatFloat32(r),normals:this.concatFloat32(i),colors:this.concatFloat32(o),selectionColors:this.concatFloat32(n),textureCoordinates:this.concatFloat32(a),textures:s};return new w(u)},t.concatFloat32=function(t){if(t&&!(t.length<=0)){for(var e=[],r=0;r<t.length;r++)this.concat(e,t[r]);return new Float32Array(e)}console.log("========================")},t.concat=function(t,e){e.forEach((function(e){t.push(e)}))},t}(),N=function(t,e){this.position=t,this.direction=e};export{w as BatchObject,b as Buffer,P as BufferBatch,a as Camera,V as Cube,L as Cylinder,N as GeometryLine,x as GeometryPlane,F as Line,_ as Obj,R as Point,O as Polygon,S as Rectangle,n as Shader,s as Sun,M as WebGL};
